name: Frontend Deploy to Alibaba Cloud OSS

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/frontend-deploy.yml
  workflow_dispatch:
    branches: [main, test]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: Verify environment configuration
        run: |
          echo "üîç Checking .env.production file..."
          if [ ! -f .env.production ]; then
            echo "‚ùå Error: .env.production file not found!"
            echo "Please ensure .env.production is committed to the repository."
            exit 1
          fi

          echo "‚úÖ .env.production exists"
          echo ""
          echo "üìã Environment variables (values hidden for security):"
          grep -E "^VITE_" .env.production | sed 's/=.*/=***/' || true

      - name: Build frontend
        run: |
          pnpm run build
        env:
          # Production environment variables are loaded from .env.production
          NODE_ENV: production

      - name: Setup Alibaba Cloud CLI
        run: |
          wget https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar -xzf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          aliyun version

      - name: Configure Alibaba Cloud credentials
        run: |
          aliyun configure set \
            --profile default \
            --mode AK \
            --region ${{ secrets.ALIYUN_REGION }} \
            --access-key-id ${{ secrets.ACR_ACCESS_KEY_ID }} \
            --access-key-secret ${{ secrets.ACR_ACCESS_KEY_SECRET }}

      - name: Install ossutil 2.0
        run: |
          # Download ossutil 2.0 for Linux x86_64
          curl -o ossutil-2.2.0-linux-amd64.zip https://gosspublic.alicdn.com/ossutil/v2/2.2.0/ossutil-2.2.0-linux-amd64.zip

          # Verify SHA256 checksum
          echo "9e02837d806cfe976ae6c1fc22557d8e0a394ca6d298b45fb9f48a360d3a67f4  ossutil-2.2.0-linux-amd64.zip" | sha256sum -c

          # Extract and install
          unzip -q ossutil-2.2.0-linux-amd64.zip
          cd ossutil-2.2.0-linux-amd64
          chmod 755 ossutil
          sudo mv ossutil /usr/local/bin/

          # Verify installation
          ossutil version

      - name: Configure ossutil 2.0
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.ACR_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.ACR_ACCESS_KEY_SECRET }}
          OSS_REGION: ${{ secrets.ALIYUN_REGION }}
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
        run: |
          # ossutil 2.0 will automatically use OSS_* environment variables
          # Verify configuration
          ossutil ls oss://${{ secrets.OSS_BUCKET_NAME }} --limited-num 1

      - name: Sync to OSS
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.ACR_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.ACR_ACCESS_KEY_SECRET }}
          OSS_REGION: ${{ secrets.ALIYUN_REGION }}
        run: |
          # Sync build directory to OSS bucket using ossutil 2.0
          # --delete: Delete files in OSS that don't exist locally
          # --force: Force overwrite without confirmation
          # --update: Only sync files that are newer at source (compares modification time)
          # Note: --update, --size-only, --checksum, --ignore-existing are mutually exclusive
          ossutil sync \
            dist/ \
            oss://${{ secrets.OSS_BUCKET_NAME }}/ \
            --delete \
            --force \
            --update

          echo "‚úÖ Files synced to OSS bucket: ${{ secrets.OSS_BUCKET_NAME }}"

      - name: Refresh CDN cache (optional)
        if: env.CDN_DOMAIN != ''
        env:
          CDN_DOMAIN: ${{ secrets.CDN_DOMAIN }}
        run: |
          # Refresh CDN cache for the entire domain
          aliyun esa PurgeCaches --region cn-hangzhou --Content '{"CacheKeys":[{}],"Directories":["https://raas.hannalink.com/"]}' --SiteId 1119720405404128 --Type hostname

      - name: Deployment summary
        if: success()
        run: |
          echo "‚úÖ Frontend deployment successful!"
          echo "üì¶ Build output: dist/"
          echo "‚òÅÔ∏è  OSS Bucket: ${{ secrets.OSS_BUCKET_NAME }}"
          if [ -n "${{ secrets.CDN_DOMAIN }}" ]; then
            echo "üåê CDN Domain: ${{ secrets.CDN_DOMAIN }}"
            echo ""
            echo "Next steps:"
            echo "1. Access your application at: https://${{ secrets.CDN_DOMAIN }}"
          else
            echo "üåê CDN Domain: Not configured"
            echo ""
            echo "Next steps:"
            echo "1. Access your application via OSS endpoint"
          fi
          echo "2. Verify the frontend can connect to the backend API"
          echo "3. Test the login functionality"
